<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <title>📱 WhatsApp System - Backup</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #25D366, #128C7E); 
            color: white; margin: 0; padding: 20px; min-height: 100vh;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header { 
            background: rgba(0,0,0,0.2); padding: 20px; 
            border-radius: 10px; text-align: center; margin-bottom: 20px;
        }
        .status { 
            background: rgba(255,255,255,0.1); padding: 15px; 
            border-radius: 8px; margin: 15px 0; border-left: 4px solid #22c55e;
        }
        .error { border-left-color: #ef4444; }
        .warning { border-left-color: #f59e0b; }
        .btn { 
            background: #22c55e; color: white; padding: 12px 25px; 
            border: none; border-radius: 6px; cursor: pointer; 
            margin: 5px; font-size: 1em;
        }
        .btn:hover { background: #16a34a; }
        .qr-area { 
            background: white; color: black; padding: 20px; 
            border-radius: 8px; text-align: center; margin: 20px 0;
            min-height: 250px; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📱 WhatsApp Connect</h1>
            <p>Sistema Backup | VPS: 212.85.11.238:3000</p>
            <p>⏰ <span id="time"></span></p>
    </div>
    
        <div id="status" class="status">
            <h3>🔧 Status Sistema</h3>
            <div id="status-info">⏳ Carregando...</div>
    </div>
    
        <div style="text-align: center;">
            <button class="btn" onclick="testarConexao()">🧪 Testar VPS</button>
            <button class="btn" onclick="conectarWhatsApp()">📱 Conectar</button>
            <button class="btn" onclick="verificarStatus()">🔍 Status</button>
    </div>
    
        <div id="qr-container" style="display: none;">
            <h3>📱 QR Code WhatsApp</h3>
            <div id="qr-area" class="qr-area">Carregando...</div>
            <div style="text-align: center;">
                <button class="btn" onclick="atualizarQR()">🔄 Atualizar</button>
                <button class="btn" onclick="fecharQR()">❌ Fechar</button>
    </div>
    </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        const VPS = 'http://212.85.11.238:3000';
        let qrInstance = null;
        let timer = null;
        
        console.log('📱 WhatsApp Backup System');
        console.log('🌐 VPS:', VPS);
        
        document.getElementById('time').textContent = new Date().toLocaleString();
        
        // Auto-start
        setTimeout(testarConexao, 1000);
        
        function testarConexao() {
            const status = document.getElementById('status');
            const info = document.getElementById('status-info');
            
            status.className = 'status';
            info.innerHTML = '⏳ Testando VPS...';
            
            fetch(VPS + '/status?test=' + Date.now(), {cache: 'no-cache'})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    status.className = 'status';
                    info.innerHTML = `
                        <div style="color: #22c55e;">✅ VPS ONLINE</div>
                        <div>📡 ${VPS}</div>
                        <div>📊 ${JSON.stringify(data)}</div>
                    `;
                    console.log('✅ VPS OK');
                    setTimeout(verificarStatus, 1000);
                })
                .catch(err => {
                    status.className = 'status error';
                    info.innerHTML = `
                        <div style="color: #ef4444;">❌ VPS OFFLINE</div>
                        <div>🚨 ${err.message}</div>
                    `;
                    console.error('❌ VPS Error:', err);
                });
        }
        
        function verificarStatus() {
            fetch(VPS + '/status?check=' + Date.now(), {cache: 'no-cache'})
                .then(r => r.json())
                .then(data => {
                    const status = document.getElementById('status');
                    const info = document.getElementById('status-info');
                    
                    if (data.ready) {
                        status.className = 'status';
                        info.innerHTML = `
                            <div style="color: #22c55e;">✅ WHATSAPP CONECTADO</div>
                            <div>📱 Pronto para uso</div>
                        `;
                    } else {
                        status.className = 'status warning';
                        info.innerHTML = `
                            <div style="color: #f59e0b;">🔴 WHATSAPP DESCONECTADO</div>
                            <div>📱 Use "Conectar" para escanear QR</div>
                        `;
                    }
                })
                .catch(err => {
                    console.error('Status error:', err);
                });
        }
        
        function conectarWhatsApp() {
            document.getElementById('qr-container').style.display = 'block';
            carregarQR();
            timer = setInterval(monitorar, 3000);
        }
        
        function carregarQR() {
            const area = document.getElementById('qr-area');
            area.innerHTML = 'Carregando QR...';
            
            fetch(VPS + '/qr?load=' + Date.now(), {cache: 'no-cache'})
                .then(r => r.json())
                .then(data => {
                    area.innerHTML = '';
                    if (data.qr) {
                        qrInstance = new QRCode(area, {
                            text: data.qr,
                            width: 200,
                            height: 200
                        });
                        console.log('📱 QR loaded');
                    } else {
                        area.innerHTML = '<div style="color: red;">❌ QR indisponível</div>';
                    }
                })
                .catch(err => {
                    area.innerHTML = '<div style="color: red;">❌ Erro: ' + err.message + '</div>';
                });
        }
        
        function monitorar() {
            fetch(VPS + '/status?monitor=' + Date.now(), {cache: 'no-cache'})
                .then(r => r.json())
                .then(data => {
                    if (data.ready) {
                        clearInterval(timer);
                        document.getElementById('qr-area').innerHTML = 
                            '<div style="color: green; font-size: 1.5em;">✅ CONECTADO!</div>';
                        console.log('🎉 Connected!');
                        setTimeout(() => {
                            fecharQR();
                            verificarStatus();
                        }, 2000);
                    }
                })
                .catch(err => console.log('Monitor error:', err));
        }
        
        function atualizarQR() {
            carregarQR();
        }
        
        function fecharQR() {
            document.getElementById('qr-container').style.display = 'none';
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }
        
        // Auto-refresh
        setInterval(verificarStatus, 120000);
        
        console.log('🎯 Backup system ready!');
    </script>
</body>
</html> 