<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="-1">
    <title>📱 WhatsApp - Sistema Final</title>
    <style>
        body { 
            font-family: Arial, sans-serif; margin: 0; padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .hero { 
            background: rgba(255,255,255,0.1); padding: 30px; 
            border-radius: 15px; text-align: center; margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        .hero h1 { font-size: 2.5em; margin-bottom: 15px; }
        .status-box { 
            background: rgba(255,255,255,0.15); padding: 20px; 
            border-radius: 10px; margin: 20px 0; border-left: 4px solid #22c55e;
        }
        .error { border-left-color: #ef4444; background: rgba(239,68,68,0.2); }
        .warning { border-left-color: #f59e0b; background: rgba(245,158,11,0.2); }
        .success { border-left-color: #22c55e; background: rgba(34,197,94,0.2); }
        .btn { 
            background: #22c55e; color: white; padding: 15px 30px; 
            border: none; border-radius: 8px; cursor: pointer; 
            font-size: 1.1em; margin: 10px; transition: all 0.3s;
        }
        .btn:hover { background: #16a34a; transform: translateY(-2px); }
        .btn-blue { background: #3b82f6; } .btn-blue:hover { background: #2563eb; }
        .qr-area { 
            background: white; color: black; padding: 30px; 
            border-radius: 10px; text-align: center; margin: 20px 0;
            min-height: 300px; display: flex; align-items: center; 
            justify-content: center; flex-direction: column;
        }
        .modal { 
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999;
        }
        .modal-content { 
            background: white; color: black; margin: 5% auto; 
            padding: 30px; border-radius: 15px; max-width: 600px; position: relative;
        }
        .close { 
            position: absolute; top: 10px; right: 15px; 
            font-size: 24px; cursor: pointer; color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>📱 WhatsApp Connect</h1>
            <p>Sistema Final com URLs VPS Hardcoded</p>
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin: 15px 0; font-family: monospace;">
                🌐 VPS: 212.85.11.238:3000 | ⏰ <span id="timestamp"></span>
            </div>
        </div>

        <div id="vps-status" class="status-box">
            <h3>🔧 Status da VPS</h3>
            <div id="vps-info">⏳ Verificando...</div>
        </div>

        <div id="whatsapp-status" class="status-box">
            <h3>📱 Status WhatsApp</h3>
            <div id="whatsapp-info">⏳ Aguardando...</div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="conectar()">📱 Conectar WhatsApp</button>
            <button class="btn btn-blue" onclick="verificar()">🔍 Verificar Status</button>
            <button class="btn btn-blue" onclick="testar()">🧪 Testar VPS</button>
        </div>

        <!-- Modal QR -->
        <div id="qr-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="fechar()">&times;</span>
                <h3>📱 Escanear QR Code</h3>
                <div id="qr-area" class="qr-area">Carregando...</div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="atualizar()">🔄 Atualizar</button>
                    <button class="btn btn-blue" onclick="fechar()">❌ Fechar</button>
                </div>
                <div id="feedback" style="text-align: center; margin: 15px 0; font-weight: bold;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // URLs HARDCODED - NÃO PODE SER ALTERADO POR CACHE
        const API = 'http://212.85.11.238:3000';
        const NOW = new Date();
        
        console.log('📱 WhatsApp System Loaded');
        console.log('🌐 API URL:', API);
        console.log('⏰ Time:', NOW.toISOString());
        
        document.getElementById('timestamp').textContent = NOW.toLocaleString();
        
        let qr = null;
        let timer = null;

        // Auto-start
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(testar, 500);
        });

        function testar() {
            const box = document.getElementById('vps-status');
            const info = document.getElementById('vps-info');
            
            box.className = 'status-box';
            info.innerHTML = '⏳ Testando VPS...';
            
            const start = Date.now();
            
            fetch(API + '/status?_=' + Date.now())
                .then(r => {
                    const time = Date.now() - start;
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json().then(data => ({data, time}));
                })
                .then(({data, time}) => {
                    box.className = 'status-box success';
                    info.innerHTML = `
                        <div style="color: #22c55e; font-weight: bold; font-size: 1.2em;">✅ VPS ONLINE</div>
                        <div>📡 URL: ${API}</div>
                        <div>⚡ Tempo: ${time}ms</div>
                        <div>📊 Dados: ${JSON.stringify(data)}</div>
                    `;
                    console.log('✅ VPS OK:', data);
                    setTimeout(verificar, 1000);
                })
                .catch(err => {
                    box.className = 'status-box error';
                    info.innerHTML = `
                        <div style="color: #ef4444; font-weight: bold;">❌ VPS OFFLINE</div>
                        <div>🚨 Erro: ${err.message}</div>
                    `;
                    console.error('❌ VPS Error:', err);
                });
        }

        function verificar() {
            const box = document.getElementById('whatsapp-status');
            const info = document.getElementById('whatsapp-info');
            
            box.className = 'status-box';
            info.innerHTML = '🔍 Verificando WhatsApp...';
            
            fetch(API + '/status?_=' + Date.now())
                .then(r => r.json())
                .then(data => {
                    if (data.ready) {
                        box.className = 'status-box success';
                        info.innerHTML = `
                            <div style="color: #22c55e; font-weight: bold; font-size: 1.2em;">✅ WHATSAPP CONECTADO</div>
                            <div>📱 Número: ${data.number || 'N/A'}</div>
                            <div>🔗 Status: Pronto para uso</div>
                            <div>⏰ Sessão: ${data.lastSession ? new Date(data.lastSession).toLocaleString() : 'N/A'}</div>
                        `;
                    } else {
                        box.className = 'status-box warning';
                        info.innerHTML = `
                            <div style="color: #f59e0b; font-weight: bold;">🔴 WHATSAPP DESCONECTADO</div>
                            <div>📱 Ação: Escanear QR Code</div>
                            <div>🔧 Clique em "Conectar WhatsApp"</div>
                        `;
                    }
                })
                .catch(err => {
                    box.className = 'status-box error';
                    info.innerHTML = `
                        <div style="color: #ef4444; font-weight: bold;">❌ ERRO</div>
                        <div>🚨 ${err.message}</div>
                    `;
                });
        }

        function conectar() {
            document.getElementById('qr-modal').style.display = 'block';
            document.getElementById('qr-area').innerHTML = 'Carregando QR...';
            document.getElementById('feedback').innerHTML = '';
            
            carregarQR();
            timer = setInterval(checarConexao, 3000);
        }

        function carregarQR() {
            const area = document.getElementById('qr-area');
            
            fetch(API + '/qr?_=' + Date.now())
                .then(r => r.json())
                .then(data => {
                    area.innerHTML = '';
                    
                    if (data.qr) {
                        qr = new QRCode(area, {
                            text: data.qr,
                            width: 280,
                            height: 280
                        });
                        
                        document.getElementById('feedback').innerHTML = 
                            '<div style="color: #3b82f6;">📱 Escaneie com WhatsApp</div>';
                        
                        console.log('📱 QR loaded');
                    } else {
                        area.innerHTML = '<div style="color: red; padding: 40px;">❌ QR indisponível</div>';
                    }
                })
                .catch(err => {
                    area.innerHTML = `<div style="color: red; padding: 40px;">❌ Erro: ${err.message}</div>`;
                });
        }

        function checarConexao() {
            fetch(API + '/status?_=' + Date.now())
                .then(r => r.json())
                .then(data => {
                    if (data.ready) {
                        clearInterval(timer);
                        
                        document.getElementById('qr-area').innerHTML = `
                            <div style="color: green; font-size: 1.5em; padding: 40px;">
                                ✅ CONECTADO!<br>
                                <small>Sistema pronto</small>
                            </div>
                        `;
                        
                        document.getElementById('feedback').innerHTML = 
                            '<div style="color: green;">🎉 Conectado com sucesso!</div>';
                        
                        console.log('🎉 Connected!');
                        
                        setTimeout(() => {
                            fechar();
                            verificar();
                        }, 3000);
                    }
                })
                .catch(err => console.log('Check failed:', err));
        }

        function atualizar() {
            carregarQR();
        }

        function fechar() {
            document.getElementById('qr-modal').style.display = 'none';
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        // Close on outside click
        window.onclick = function(event) {
            if (event.target == document.getElementById('qr-modal')) {
                fechar();
            }
        }

        // Auto-refresh every minute
        setInterval(verificar, 60000);
        
        console.log('🎯 Ready!');
    </script>
</body>
</html> 