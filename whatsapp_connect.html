<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="-1">
    <title>🚀 WhatsApp Connect - Sistema Definitivo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .hero { 
            text-align: center; background: rgba(255,255,255,0.1); 
            padding: 40px; border-radius: 20px; margin-bottom: 30px; 
            backdrop-filter: blur(15px); box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .hero h1 { font-size: 3em; margin-bottom: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .hero p { font-size: 1.3em; opacity: 0.9; }
        
        .status-card { 
            background: rgba(255,255,255,0.15); border-radius: 15px; 
            padding: 25px; margin: 20px 0; backdrop-filter: blur(10px);
            border-left: 5px solid #22c55e;
        }
        .status-card.error { border-left-color: #ef4444; background: rgba(239,68,68,0.2); }
        .status-card.warning { border-left-color: #f59e0b; background: rgba(245,158,11,0.2); }
        .status-card.success { border-left-color: #22c55e; background: rgba(34,197,94,0.2); }
        
        .btn { 
            background: #22c55e; color: white; padding: 18px 35px; 
            border: none; border-radius: 12px; cursor: pointer; 
            font-size: 1.2em; font-weight: 600; margin: 10px; 
            transition: all 0.3s ease; text-decoration: none; display: inline-block;
        }
        .btn:hover { 
            background: #16a34a; transform: translateY(-3px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        .btn-primary { background: #3b82f6; } .btn-primary:hover { background: #2563eb; }
        .btn-purple { background: #7c3aed; } .btn-purple:hover { background: #6d28d9; }
        
        .qr-container { 
            background: white; color: black; border-radius: 20px; 
            padding: 40px; text-align: center; margin: 25px auto; 
            max-width: 500px; min-height: 400px;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        
        .modal { 
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
            z-index: 9999; backdrop-filter: blur(8px);
        }
        .modal-content { 
            background: white; color: black; margin: 2% auto; 
            padding: 50px; border-radius: 25px; max-width: 700px; 
            position: relative; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        
        .close { 
            position: absolute; top: 20px; right: 25px; 
            font-size: 35px; cursor: pointer; color: #666; font-weight: bold;
        }
        .close:hover { color: #000; }
        
        .debug-panel { 
            background: rgba(0,0,0,0.4); border-radius: 10px; 
            padding: 20px; margin: 20px 0; font-family: 'Courier New', monospace; 
            font-size: 0.95em; border: 1px solid rgba(255,255,255,0.2);
        }
        
        .status-indicator { font-size: 1.4em; font-weight: bold; margin: 15px 0; }
        .status-connected { color: #22c55e; }
        .status-disconnected { color: #f59e0b; }
        .status-error { color: #ef4444; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0; }
        
        @media (max-width: 768px) {
            .hero h1 { font-size: 2em; }
            .hero p { font-size: 1.1em; }
            .btn { padding: 15px 25px; font-size: 1em; }
            .modal-content { margin: 10% auto; padding: 30px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>🚀 WhatsApp Connect</h1>
            <p>Sistema Zero-Cache com URLs VPS Hardcoded</p>
            <div class="debug-panel">
                📡 VPS: 212.85.11.238:3000 | ⏰ <span id="load-time"></span>
            </div>
        </div>

        <div id="vps-status" class="status-card">
            <h3>🔧 Status da VPS</h3>
            <div id="vps-info">⏳ Verificando conectividade...</div>
        </div>

        <div id="whatsapp-status" class="status-card">
            <h3>📱 Status WhatsApp</h3>
            <div id="whatsapp-info">⏳ Aguardando verificação da VPS...</div>
        </div>

        <div class="grid">
            <div style="text-align: center;">
                <h3>🎯 Ações Principais</h3>
                <button class="btn" onclick="conectarWhatsApp()">📱 Conectar WhatsApp</button>
                <button class="btn btn-primary" onclick="verificarStatus()">🔍 Verificar Status</button>
                <button class="btn btn-purple" onclick="testarVPS()">🧪 Testar VPS</button>
            </div>
            
            <div style="text-align: center;">
                <h3>📊 Informações do Sistema</h3>
                <div class="debug-panel" style="text-align: left;">
                    <div>🌐 <strong>URL VPS:</strong> 212.85.11.238:3000</div>
                    <div>🔄 <strong>Cache:</strong> Completamente desabilitado</div>
                    <div>📅 <strong>Versão:</strong> 2.0-DEFINITIVA</div>
                    <div>⚡ <strong>Método:</strong> URLs Hardcoded</div>
                </div>
            </div>
        </div>

        <!-- Modal QR Code -->
        <div id="qr-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="fecharModal()">&times;</span>
                <h2 style="text-align: center; margin-bottom: 25px;">📱 Conectar WhatsApp</h2>
                
                <div id="qr-container" class="qr-container">
                    Carregando QR Code...
                </div>
                
                <div id="connection-feedback" style="text-align: center; margin: 20px 0; font-weight: bold;"></div>
                
                <div style="text-align: center;">
                    <button class="btn" onclick="atualizarQR()">🔄 Atualizar QR</button>
                    <button class="btn btn-primary" onclick="fecharModal()">❌ Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // ===== CONFIGURAÇÃO HARDCODED - IMPOSSÍVEL DE SER ALTERADA POR CACHE =====
        const VPS_URL = 'http://212.85.11.238:3000';
        const SYSTEM_VERSION = '2.0-DEFINITIVA';
        const LOAD_TIME = new Date();
        
        console.log('🚀 === WHATSAPP CONNECT SYSTEM V2 ===');
        console.log('📡 VPS URL (Hardcoded):', VPS_URL);
        console.log('📅 Load Time:', LOAD_TIME.toISOString());
        console.log('🔧 System Version:', SYSTEM_VERSION);
        console.log('⚡ Cache Status: COMPLETELY DISABLED');
        
        document.getElementById('load-time').textContent = LOAD_TIME.toLocaleString();
        
        let qrCodeInstance = null;
        let connectionTimer = null;
        let statusCheckTimer = null;

        // Auto-start verification
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(testarVPS, 500);
        });

        function testarVPS() {
            const statusDiv = document.getElementById('vps-status');
            const infoDiv = document.getElementById('vps-info');
            
            statusDiv.className = 'status-card';
            infoDiv.innerHTML = '⏳ Testando conectividade com VPS...';
            
            const startTime = performance.now();
            
            fetch(VPS_URL + '/status?_t=' + Date.now())
                .then(response => {
                    const responseTime = Math.round(performance.now() - startTime);
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json().then(data => ({ data, responseTime }));
                })
                .then(({ data, responseTime }) => {
                    statusDiv.className = 'status-card success';
                    infoDiv.innerHTML = `
                        <div class="status-indicator status-connected">✅ VPS ONLINE</div>
                        <div>📡 <strong>URL:</strong> ${VPS_URL}</div>
                        <div>⚡ <strong>Tempo:</strong> ${responseTime}ms</div>
                        <div>📊 <strong>API:</strong> Respondendo normalmente</div>
                        <div>🔧 <strong>Status:</strong> ${JSON.stringify(data)}</div>
                    `;
                    
                    console.log('✅ VPS Online:', data);
                    console.log('⚡ Response Time:', responseTime + 'ms');
                    
                    // Auto-check WhatsApp status
                    setTimeout(verificarStatus, 1000);
                })
                .catch(error => {
                    statusDiv.className = 'status-card error';
                    infoDiv.innerHTML = `
                        <div class="status-indicator status-error">❌ VPS OFFLINE</div>
                        <div>🚨 <strong>Erro:</strong> ${error.message}</div>
                        <div>🔧 <strong>Verificação:</strong> Falhou</div>
                    `;
                    
                    console.error('❌ VPS Error:', error);
                });
        }

        function verificarStatus() {
            const statusDiv = document.getElementById('whatsapp-status');
            const infoDiv = document.getElementById('whatsapp-info');
            
            statusDiv.className = 'status-card';
            infoDiv.innerHTML = '🔍 Verificando status do WhatsApp...';
            
            fetch(VPS_URL + '/status?_t=' + Date.now())
                .then(response => response.json())
                .then(data => {
                    if (data.ready) {
                        statusDiv.className = 'status-card success';
                        infoDiv.innerHTML = `
                            <div class="status-indicator status-connected">✅ WHATSAPP CONECTADO</div>
                            <div>📱 <strong>Número:</strong> ${data.number || 'Não identificado'}</div>
                            <div>🔗 <strong>Status:</strong> Pronto para envio/recebimento</div>
                            <div>⏰ <strong>Última sessão:</strong> ${data.lastSession ? new Date(data.lastSession).toLocaleString() : 'N/A'}</div>
                        `;
                    } else {
                        statusDiv.className = 'status-card warning';
                        infoDiv.innerHTML = `
                            <div class="status-indicator status-disconnected">🔴 WHATSAPP DESCONECTADO</div>
                            <div>📱 <strong>Ação necessária:</strong> Escanear QR Code</div>
                            <div>🔧 <strong>Próximo passo:</strong> Clique em "Conectar WhatsApp"</div>
                        `;
                    }
                })
                .catch(error => {
                    statusDiv.className = 'status-card error';
                    infoDiv.innerHTML = `
                        <div class="status-indicator status-error">❌ ERRO NA VERIFICAÇÃO</div>
                        <div>🚨 <strong>Erro:</strong> ${error.message}</div>
                    `;
                });
        }

        function conectarWhatsApp() {
            document.getElementById('qr-modal').style.display = 'block';
            document.getElementById('qr-container').innerHTML = 'Carregando QR Code...';
            document.getElementById('connection-feedback').innerHTML = '';
            
            carregarQRCode();
            
            // Check connection every 3 seconds
            connectionTimer = setInterval(verificarConexaoModal, 3000);
        }

        function carregarQRCode() {
            const qrContainer = document.getElementById('qr-container');
            
            fetch(VPS_URL + '/qr?_t=' + Date.now())
                .then(response => response.json())
                .then(data => {
                    qrContainer.innerHTML = '';
                    
                    if (data.qr) {
                        qrCodeInstance = new QRCode(qrContainer, {
                            text: data.qr,
                            width: 300,
                            height: 300,
                            colorDark: '#000000',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.M
                        });
                        
                        document.getElementById('connection-feedback').innerHTML = 
                            '<div style="color: #3b82f6; font-size: 1.1em;">📱 Escaneie com seu WhatsApp</div>';
                            
                        console.log('📱 QR Code loaded successfully');
                    } else {
                        qrContainer.innerHTML = '<div style="color: red; font-size: 1.2em; padding: 50px;">❌ QR Code indisponível<br><small>Aguarde ou tente atualizar</small></div>';
                    }
                })
                .catch(error => {
                    qrContainer.innerHTML = `<div style="color: red; font-size: 1.2em; padding: 50px;">❌ Erro ao carregar QR<br><small>${error.message}</small></div>`;
                    console.error('❌ QR Load Error:', error);
                });
        }

        function verificarConexaoModal() {
            fetch(VPS_URL + '/status?_t=' + Date.now())
                .then(response => response.json())
                .then(data => {
                    if (data.ready) {
                        // SUCCESS!
                        clearInterval(connectionTimer);
                        
                        document.getElementById('qr-container').innerHTML = `
                            <div style="color: green; font-size: 2em; padding: 60px;">
                                ✅ CONECTADO COM SUCESSO!<br>
                                <small style="font-size: 0.6em;">Sistema pronto para uso</small>
                            </div>
                        `;
                        
                        document.getElementById('connection-feedback').innerHTML = 
                            '<div style="color: green; font-size: 1.2em;">🎉 WhatsApp conectado!</div>';
                        
                        console.log('🎉 WhatsApp connected successfully!');
                        
                        // Auto-close modal after 3 seconds
                        setTimeout(() => {
                            fecharModal();
                            verificarStatus(); // Update main status
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.log('Connection check failed:', error);
                });
        }

        function atualizarQR() {
            carregarQRCode();
        }

        function fecharModal() {
            document.getElementById('qr-modal').style.display = 'none';
            if (connectionTimer) {
                clearInterval(connectionTimer);
                connectionTimer = null;
            }
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('qr-modal');
            if (event.target === modal) {
                fecharModal();
            }
        }

        // Auto-refresh status every 60 seconds
        setInterval(verificarStatus, 60000);
        
        console.log('🎯 System ready for WhatsApp connection!');
    </script>
</body>
</html> 